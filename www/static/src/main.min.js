/*Created by Nuno Machado*/
var nmm=nmm||{};nmm.MapView=function(){"use strict";function a(a){b=this,this._controller=a,this._icons=null,this._markers=[],this._setFailTimeout()}var b,c=a.prototype;return c.toggleMarkerAnimation=function(a,b){var c,d,e=this._markers.length;for(c=0;c<e;c++)if(this._markers[c].id===a){d=this._markers[c];break}d&&(d.getAnimation()||b?d.setAnimation(null):d.setAnimation(google.maps.Animation.BOUNCE))},c.displayMarkers=function(a){var b,c,d,e=this._markers.length,f=a.length;for(b=0;b<e;b++){for(d=!1,c=0;c<f;c++)if(this._markers[b].id===a[c].id){d=!0;break}this._markers[b].setVisible(d)}},c.addNewMarker=function(a){var c=parseFloat(a.latitude),d=parseFloat(a.longitude),e=new google.maps.Marker({position:{lat:c,lng:d},map:this._map,id:a.id,icon:this._icons[a.type]});e.addListener("click",function(){b._controller.markerClicked(e)},!1),this._markers.push(e)},c.createMarkers=function(a,b){this._icons=b,a.forEach(function(a){this.addNewMarker(a)},this)},c.renderMap=function(a){this._map=new google.maps.Map(document.getElementById("map"),{zoom:a.zoom,center:a}),clearTimeout(this._failTimeout),this._controller.mapTaskEnd(!0),google.maps.event.addListener(this._map,"click",function(a){b._controller.mapClicked(a.latLng.lat(),a.latLng.lng())})},c._setFailTimeout=function(){this._failTimeout=setTimeout(function(){b._controller.mapTaskEnd(!1)},1e4)},a}();var nmm=nmm||{};nmm.Model=function(){"use strict";function a(a){b=this,this._controller=a,this.user_id=ko.observable(),this.appStatus={state:ko.observable(0)},this.appStatus.message=ko.computed(function(){switch(b.appStatus.state()){case-1:return"An error occurred and some content could not be loaded. Please check your Internet connection and reload the page!";case 0:return"Loading map";case 1:return"Loading markers";case 2:return b.user_id()?"Click to place a marker":"Login to place markers / favourites"}}),this.mapParams={init:{city:"Porto",lat:41.1452347,lng:-8.6454186,zoom:14},markerIcons:{monument:"/static/assets/icon_monument.png",museum:"/static/assets/icon_museum.png",hotel:"/static/assets/icon_hotel.png",restaurant:"/static/assets/icon_restaurant.png",coffee:"/static/assets/icon_coffee.png",other:"/static/assets/icon_other.png"},markers:[],currentMarker:{id:ko.observable(),title:ko.observable(),type:ko.observable(),latitude:ko.observable(),longitude:ko.observable(),description:ko.observable(),sharedBy:ko.observable(),sharerPic:ko.observable(),userFavourite:ko.observable()}},this.mapParams.currentMarker.userFavouriteButtonClass=ko.computed(function(){return b.mapParams.currentMarker.userFavourite()?"favourite":"unfavourite"}),this.userFavs=[],this.modals={modalClass:ko.observable("modal-out"),addOn:ko.observable(!1),viewOn:ko.observable(!1),add:{title:ko.observable(),latitude:ko.observable(),longitude:ko.observable(),description:ko.observable(),type:ko.observable("other"),warning:ko.observable()}},this.aside={asideClass:ko.observable("menu-out"),asideContent:ko.observable("checks"),checks:{monument:ko.observable(!0),museum:ko.observable(!0),hotel:ko.observable(!0),restaurant:ko.observable(!0),coffee:ko.observable(!0),other:ko.observable(!0),userOnly:ko.observable(!1),favOnly:ko.observable(!1)}},this.displayList=ko.computed(function(){if(b.aside.checks.monument(),b.aside.checks.museum(),b.aside.checks.hotel(),b.aside.checks.restaurant(),b.aside.checks.coffee(),b.aside.checks.other(),b.aside.checks.userOnly(),b.aside.checks.monument(),b.appStatus.state()<2)return b.mapParams.markers;var a=[];return b.mapParams.markers.forEach(function(c){var d=b.aside.checks[c.type]();b.aside.checks.userOnly()&&c.user_id!==b.user_id()&&(d=!1),b.aside.checks.favOnly()&&!b.checkIfUserFavourite(c.id)&&(d=!1),d&&a.push(c)}),b._controller.displayMarkers(a),a}),this.weather={weather:ko.observable(),icon:ko.observable(),windSpeed:ko.observable(),humidity:ko.observable(),temp:ko.observable(),tempMax:ko.observable(),tempMin:ko.observable(),warning:ko.observable()}}var b,c=a.prototype;return c.getOpenWeather=function(){var a="http://api.openweathermap.org/data/2.5/weather?q=porto,pt&units=metric&appid=7c0c2602f161b260daf19fa64ac7974a";$.ajax({url:a,dataType:"json"}).done(function(a){b.weather.weather(a.weather[0].description),b.weather.icon("http://openweathermap.org/img/w/"+a.weather[0].icon+".png"),b.weather.windSpeed(a.wind.speed),b.weather.humidity(a.main.humidity),b.weather.temp(a.main.temp),b.weather.tempMax(a.main.temp_max),b.weather.tempMin(a.main.temp_min),b.weather.warning("")}).fail(function(a){this.weather.warning("It wasn't possible to retrieve current weather conditions.")})},c.storeNewMarker=function(a){var b=this;$.post("/add",a,function(a,c){"success"===c?(b.mapParams.markers.push(a.Marker),b._controller.updateExistingMarkers(a.Marker)):alert("Something went wrong while saving your marker. Please reload the page and try again.")})},c.evaluateInputData=function(){var a=this.modals.add;a.title()&&a.description&&a.type?this.storeNewMarker({title:a.title(),latitude:a.latitude(),longitude:a.longitude(),type:a.type(),description:a.description()}):a.warning("Some info is missing.")},c.resetAddMarkerModal=function(){this.modals.add.title(""),this.modals.add.latitude(""),this.modals.add.longitude(""),this.modals.add.description(""),this.modals.add.type("other"),this.modals.add.warning("")},c.setCurrentMarker=function(a){var b,c,d=this.mapParams.markers.length,e=this.mapParams.currentMarker;for(b=0;b<d;b++)if(c=this.mapParams.markers[b],c.id===a){e.id(c.id),e.title(c.title),e.type(c.type),e.latitude(c.latitude),e.longitude(c.longitude),e.description(c.description),e.sharedBy(c.user_name),e.sharerPic(c.user_pic),e.userFavourite(this.checkIfUserFavourite(a));break}},c.removeFavourite=function(a){var b=this;$.post("/unfav",{marker_id:a},function(c,d){if("success"===d){var e,f=b.userFavs.length;for(e=0;e<f;e++)if(b.userFavs[e].marker_id===a){b.userFavs.splice(e,1);break}}else alert("Something went wrong while unfavouriting this marker. Please reload the page and try again.")})},c.storeFavourite=function(a){var b=this;$.post("/fav",{marker_id:a},function(c,d){"success"===d?b.userFavs.push({marker_id:a}):alert("Something went wrong while favouriting this marker. Please reload the page and try again.")})},c.checkIfUserFavourite=function(a){var b,c=this.userFavs.length;for(b=0;b<c;b++)if(this.userFavs[b].marker_id===a)return!0;return!1},c.getUserFavourites=function(a){if(a){var b=this,c="/favourites/"+a+"/JSON/";$.ajax({url:c,dataType:"json"}).done(function(a){b.userFavs=a.Favourite}).fail(function(a){alert("It wasn't possible to load your favourites. Please reload the page and try again.")})}else this.userFavs=[]},c.getDBMarkersList=function(){var a=this,b="/markers/JSON/";$.ajax({url:b,dataType:"json"}).done(function(b){var c=b.Marker;a.mapParams.markers=c,a._controller.markersListLoadTaskEnd(!0,c)}).fail(function(b){a._controller.markersListLoadTaskEnd(!1)})},a}();var nmm=nmm||{};nmm.ViewModel=function(){"use strict";function a(){b=this,this._init()}var b,c=a.prototype;return c.logout=function(){this.model.user_id(null),$.get("/disconnect/",function(a){console.log(a)})},c.listClicked=function(a){b.markerClicked(a),b.model.aside.asideClass("menu-out")},c.displayMarkers=function(a){this._mapView.displayMarkers(a)},c.toggleFavourite=function(){var a=this.model.mapParams.currentMarker.userFavourite(),b=this.model.mapParams.currentMarker.id();a?this.model.removeFavourite(b):this.model.storeFavourite(b),this.model.mapParams.currentMarker.userFavourite(!a)},c.updateExistingMarkers=function(a){this.closeModal(),this._mapView.addNewMarker(a)},c.storeMarker=function(){this.model.evaluateInputData()},c.closeModal=function(){this.model.modals.modalClass("modal-out"),this.model.modals.addOn(!1),this.model.modals.viewOn(!1),this._mapView.toggleMarkerAnimation(this.model.mapParams.currentMarker.id(),!0)},c.markerClicked=function(a){this._mapView.toggleMarkerAnimation(this.model.mapParams.currentMarker.id(),!0),this.model.setCurrentMarker(a.id),this._mapView.toggleMarkerAnimation(this.model.mapParams.currentMarker.id()),this.model.modals.modalClass("modal-in"),this.model.modals.addOn(!1),this.model.modals.viewOn(!0)},c.mapClicked=function(a,b){this.model.user_id()&&(this.model.resetAddMarkerModal(),this.model.modals.add.latitude(a),this.model.modals.add.longitude(b),this.model.modals.modalClass("modal-in"),this.model.modals.addOn(!0),this.model.modals.viewOn(!1))},c.userIdUpdate=function(a){this.model.user_id(a),this.model.getUserFavourites(a)},c.changeAsideContent=function(a,b){var c=event.target.getAttribute("data-key");this.model.aside.asideContent(c)},c.toggleAside=function(){var a="menu-out"===this.model.aside.asideClass()?"menu-in":"menu-out";this.model.aside.asideClass(a)},c.markersListLoadTaskEnd=function(a,b){a?(this._mapView.createMarkers(b,this.model.mapParams.markerIcons),this.model.appStatus.state(2)):this.model.appStatus.state(-1)},c.mapTaskEnd=function(a){a?(this.model.getDBMarkersList(),this.model.appStatus.state(1)):this.model.appStatus.state(-1)},c.renderMap=function(){this._mapView.renderMap(this.model.mapParams.init)},c._init=function(){this.model=new nmm.Model(this),this._mapView=new nmm.MapView(this),this.model.getOpenWeather()},a}(),nmm.vm=new nmm.ViewModel,ko.applyBindings(nmm.vm);